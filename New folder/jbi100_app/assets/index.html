<!doctype html>
<html lang="en">
  <head>
    <!-- ======================= PROJECT META & IMPORTS =======================
         Explains: The next lines set character encoding, viewport scaling,
         title, and import the external libraries (Mapbox GL, noUiSlider,
         Chart.js, FontAwesome). We also define our inline CSS below.         -->
    <meta charset="utf-8" />
    <title>Australia Shark Incidents Choropleth</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- MAPBOX GL JS -->
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.js"></script>
    <!-- CHART.JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- FONT AWESOME (for the Bluetooth icon) -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      integrity="sha512-LT1dI7..."
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.6.1/nouislider.min.css"/>
    <style>
      /* ==================== BASIC RESET & GLOBAL STYLES ===================== */

      body {
        margin: 0; 
        padding: 0;
        font-family: Arial, sans-serif;
      }
      /* Removes default margins, sets a consistent font */

      /* ========================== MAP & OVERLAY STYLING ========================== */

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
      /* The main map container: fills entire screen area */

      .map-overlay {
        left: 75%;
        transform: translateX(50%); /* Moves overlay horizontally, centering it */
        top: 10%;
        background: rgba(0, 0, 0, 0.8);
        box-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        padding: 20px;
        border-radius: 10px;
        color: #fff;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: auto;
        max-width: 400px;
        position: absolute;
      }
      /* A styled overlay used for info (e.g., “Number of Incidents per State”) */

      #features {
        top: 0;
        height: 100px;
        margin-top: 20px;
        width: 250px;
      }
      /* Container for small feature info, if used */

      #legend {
        position: absolute;
        bottom: 330px;
        right: 20px;
        padding: 18px;
        box-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
        line-height: 18px;
        height: 185px;
        margin-bottom: 0;
        width: 120px;
        background: rgb(0, 0, 0, 0.8);
        border-radius: 15px;
        color: #fff;
        margin-right: 20px;
        margin-right: 20px; /* Duplicate line is intentional, unchanged */
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
        padding-bottom: 20px;
      }
      /* Legend box showing color-scale or ranges */

      #legend:hover {
        transform: scale(1.015);
        box-shadow: 0 4px 8px rgba(255, 255, 255, 0.2);
      }
      /* Hover effect on legend to slightly enlarge and add a shadow */

      /* =========================== TOGGLE VIEW (BLUETOOTH SWITCH) ========================== */

      #toggle-view-overlay {
        position: absolute;
        bottom: 30px;
        left: 85%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        padding: 10px 20px;
        border-radius: 10px;
        box-shadow: -8px -8px 15px rgba(255, 255, 255, .05),
                    10px 10px 10px rgba(0, 0, 0, .02),
                    inset 8px 8px 15px rgba(255, 255, 25, .05),
                    inset 10px 10px 10px rgba(0, 0, 0, .02);
        justify-content: space-between;
        align-items: center;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
      }
      /* Floating control for toggling between heatmap & dots */

      #toggle-view-overlay .switch-label {
        padding: 0 20px 0 10px;
        color: #ffffff;
      }

      #toggle-view-overlay:hover {
        transform: scale(1.013);
      }

      #toggle-view-overlay .switch-toggle {
        height: 40px;
      }

      #toggle-view-overlay .switch-toggle input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        z-index: -2;
      }

      #toggle-view-overlay .switch-toggle input[type="checkbox"] + label {
        position: relative;
        display: inline-block;
        width: 100px;
        height: 40px;
        border-radius: 20px;
        margin: 0;
        cursor: pointer;
        box-shadow: inset -8px -8px 15px rgba(255, 255, 255, .4),
                    inset 10px 10px 10px rgba(0, 0, 0, .25);
      }

      #toggle-view-overlay .switch-toggle input[type="checkbox"] + label::before {
        position: absolute;
        content: 'OFF';
        font-size: 13px;
        text-align: center;
        line-height: 25px;
        top: 8px;
        left: 8px;
        width: 45px;
        height: 25px;
        border-radius: 20px;
        background-color: #ff0000;
        box-shadow: -3px -3px 5px rgba(255, 255, 255, .25),
                    3px 3px 5px rgba(0, 0, 0, .25);
        transition: .3s ease-in-out;
      }

      #toggle-view-overlay .switch-toggle input[type="checkbox"]:checked + label::before {
        left: 50%;
        content: 'ON';
        color: #fff;
        background-color: #00b33c;
        box-shadow: -3px -3px 5px rgba(255, 255, 255, .5),
                    3px 3px 5px #00b33c;
      }

      /* =========================== FILTER SIDEBAR (DRAGGABLE) =========================== */

      #filter-sidebar {
        position: absolute;
        top: 0;
        left: 0;
        width: 250px;
        height: 100%;
        background: #fafafa;
        border-right: 1px solid #ccc;
        padding: 15px;
        box-sizing: border-box;
        overflow-y: auto;
        cursor: move;
        z-index: 9999;
      }
      /* Sidebar that can be dragged around, containing all filter controls */

      #filter-sidebar h2 {
        margin-top: 0;
      }

      .filter-group {
        margin-bottom: 20px;
      }

      .range-values {
        display: flex;
        justify-content: space-between;
        font-size: 0.9em;
        color: #444;
      }

      input[type="range"] {
        width: 100%;
      }

      label {
        display: block;
        margin: 5px 0;
      }

      .checkbox-group label {
        display: inline-block;
        margin-right: 10px;
      }

      /* ========================== DOT HOVER INFO PANEL ========================== */

      #incident-info {
        display: none;
        position: absolute;
        top: 20px;
        left: 75%;
        padding: 10px;
        width: 180px;
        background: #fff;
        border: 2px solid #000;
        border-radius: 4px;
        font-size: 14px;
        z-index: 999;
      }
      /* Shows incident details (year, month, shark type, etc.) when hovering dots */

      /* ===================== MODAL FOR LINE/BAR CHARTS (STATE-LEVEL) ===================== */

      #plot-modal {
        display: none;
        position: absolute;
        height: 93%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 600px;
        background: #fff;
        border: 2px solid #000;
        border-radius: 6px;
        padding: 20px;
        z-index: 9999;
      }

      #plot-modal h2 {
        margin-top: 0;
        margin-bottom: -20px;
      }

      #close-modal {
        float: right;
        cursor: pointer;
        background: #e74c3c;
        border: none;
        color: #fff;
        padding: 5px 8px;
        border-radius: 3px;
      }

      #close-modal:hover {
        background: #c0392b;
      }

      .legend-key {
        display: inline-block;
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border-radius: 3px;
        color: white;
      }

      .incidentsnmbr {
        color:#fb3923;
      }

      /* ========================== RANGE SLIDER STYLING ========================== */

      .range-slider {
        position: relative;
        width: 100%;
        height: 30px;
      }

      .range-slider input[type="range"] {
        position: absolute;
        width: 100%;
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background-color: #ddd;
        border-radius: 5px;
      }

      .range-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background-color: #007bff;
        border-radius: 50%;
        cursor: pointer;
      }

      .range-values {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        font-size: 0.9em;
        color: #444;
      }

      /* ================== CLASS FOR FORCIBLY HIDING AN ELEMENT ================= */

      .hidden {
        display: none !important;
      }

      /* ============== FLOATING/DRAGGABLE WINDOW FOR OTHER PANELS ============== */

      .floating-window {
        height: 600px;
        position: absolute;
        top: 90px; /* You can tweak the default starting position */
        left: 1200px;
        width: 370px;
        padding: 20px;
        background: rgba(0,0,0,0.8);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(255, 255, 255, 0.2);
        z-index: 9999;
        color: white;
        overflow: auto;
        align-items: center;
      }
      /* Another generic floating panel style (like the filter window) */

      .window-header {
        background: rgba(0,0,0,0.5);
        padding: 5px 10px;
        border-bottom: 1px solid #ccc;
        cursor: move; /* letting users drag the header to move the window */
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      /* The top bar of the floating window that can be grabbed for dragging */


    /* The X or minimize button in the header */
    .close-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer; /* So user sees clickable pointer over the "X" */
    }

    /* The main body of the window where your filter UI goes */
    .window-body {
      padding: 10px;
      width: 100%;
      margin-right: 5px;
    }

    /* If the entire window is 'hidden' via the .hidden class, we do: */
    .floating-window.hidden {
      display: none !important; /* Force the window to vanish completely */
    }

    /* 3) The toggle button style (the 'Show Filters' button) */
    .filter-toggle-btn {
      position: absolute;
      top: 25px;  /* or whichever offset you prefer */
      left: 90%; 
      z-index: 9999;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      width: 130px;
      height: 40px;
      background: rgba(0, 0, 0, 0.8);
      box-shadow: #ccc 0 0 1px 0.4;
    }
    /* The small button that toggles the filter sidebar */

    .button-container {
      position: absolute;
      top: 10px;  /* Adjust as needed */
      left: 88%; 
      z-index: 9999;
      display: flex;
      gap: 10px; /* Space between the "Show Filters" and "Show Analysis" buttons */
    }

    /* The fixed analysis window pinned to the left side (30% width) */
    #incident-analysis-window {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 30% !important;
      height: 100% !important;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(255, 255, 255, 0.2);
      z-index: 9999;
      overflow: auto;
      display: none; /* Hidden by default, shown when user wants analysis */
    }

    #incident-analysis-window h3 {
      margin-bottom: 10px;
      text-align: center; /* Title for the analysis sub-charts */
    }

    #analysis-toggle-button {
      position: absolute;
      top: 80px;
      right: 20px;
      z-index: 9999;
      width: 130px;
      height: 40px;
      background: rgba(0, 0, 0, 0.8);
      box-shadow: #ccc 0 0 1px 0.4;
    }
    /* "Show Analysis" button, typically displayed in dot mode */

    </style>

    {%css%}
  </head>

  <body>
    <!-- MAP CONTAINER: Main map element that covers the background -->
    <div id="map"></div>

<!-- A FLOATING, DRAGGABLE WINDOW FOR FILTERS -->
<div id="filter-window" class="floating-window hidden">
  <!-- A header bar with a title and a close (X) or minimize button -->
  <div id="filter-window-header" class="window-header">
    <span>Filter Shark Incidents</span>
    <button id="filter-close-btn" class="close-btn">X</button>
  </div>

  <!-- The body of the window, where you place your sliders, checkboxes, etc. -->
  <div class="window-body" id="filter-window-body">
    
<!-- New noUiSlider for Year Range -->
<div class="filter-group" id="year-filter">
  <label><strong>Year Range:</strong></label>
  <div id="year-slider"></div>  <!-- No <input> needed, just a container <div> -->
  <div class="range-values">
    <span id="year-min-value">1791</span>
    <span id="year-max-value">2022</span>
  </div>
</div>

<!-- New noUiSlider for Month Range -->
<div class="filter-group" id="month-filter">
  <label><strong>Month Range:</strong></label>
  <div id="month-slider"></div>
  <div class="range-values">
    <span id="month-min-value">1</span>
    <span id="month-max-value">12</span>
  </div>
</div>

<!-- STATE checkboxes -->
<div class="filter-group checkbox-group" id="state-filter-group">
  <strong>State:</strong>
  <button id="toggle-states-btn" type="button">Show States</button>

  <!-- A container that starts hidden, to hold the checkboxes -->
  <div id="state-checkboxes-container" class="hidden" style="margin-top: 8px;">
    <label>
      <input type="checkbox" id="select-all-states" />
      <em>Select All States</em>
    </label>
    <br/>
  
    <!-- The actual checkboxes for each state -->
    <label><input type="checkbox" name="state-checkbox" value="NSW" checked>NSW</label>
    <label><input type="checkbox" name="state-checkbox" value="QLD" checked>QLD</label>
    <label><input type="checkbox" name="state-checkbox" value="WA" checked>WA</label>
    <label><input type="checkbox" name="state-checkbox" value="VIC" checked>VIC</label>
    <label><input type="checkbox" name="state-checkbox" value="SA" checked>SA</label>
    <label><input type="checkbox" name="state-checkbox" value="TAS" checked>TAS</label>
    <label><input type="checkbox" name="state-checkbox" value="NT" checked>NT</label>
  </div>
</div>

<!-- FATAL or not -->
<div class="filter-group">
  <strong>Outcome:</strong>
  <label><input type="radio" name="injury-outcome" value="all" checked>All</label>
  <label><input type="radio" name="injury-outcome" value="fatal">Fatal</label>
  <label><input type="radio" name="injury-outcome" value="injured">Injured</label>
  <label><input type="radio" name="injury-outcome" value="uninjured">Uninjured</label>
</div>
<!-- CORRECT snippet for sharks (new ID = "shark-filter-group") -->
<div class="filter-group checkbox-group" id="shark-filter-group">
  <strong>Type of shark:</strong>

  <button id="toggle-sharks-btn" type="button" style="margin-bottom: 5px;">
    Show Sharks
  </button>
  
  <!-- Container that starts hidden, revealing shark checkboxes when toggled -->
  <div id="shark-checkboxes-container" class="hidden filter-group checkbox-group" style="margin-top: 8px;">
    <!-- "Select All Sharks" checkbox -->
    <label>
      <input type="checkbox" id="select-all-sharks" />
      <em>Select All Sharks</em>
    </label>
    <br/>

    <!-- List of individual shark-type checkboxes, each assigned a value -->
    <label><input type="checkbox" name="shark-checkbox" value="white shark" checked>White shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="tiger shark" checked>Tiger shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="bull shark" checked>Bull shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="wobbegong" checked>Wobbegong</label>
    <label><input type="checkbox" name="shark-checkbox" value="whaler shark">Whaler shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="bronze whaler shark">Bronze whaler shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="broadnose sevengill shark">Broadnose sevengill shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="hammerhead shark">Hammerhead shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="whitetip reef shark">Whitetip reef shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="blacktip reef shark">Blacktip reef shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="grey nurse shark">Grey nurse shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="lemon shark">Lemon shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="dusky shark">Dusky shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="school shark">School shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="galapagos shark">Galapagos shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="dogfish">Dogfish</label>
    <label><input type="checkbox" name="shark-checkbox" value="shortfin mako shark">Shortfin mako shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="port jackson shark">Port Jackson shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="silvertip shark">Silvertip shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="blind shark">Blind shark</label>
    <label><input type="checkbox" name="shark-checkbox" value="grey reef shark">Grey reef shark</label>
  </div>
</div>

<!-- Simple checkboxes for body part location: leg, arm, torso, other -->
<div class="filter-group checkbox-group" id="injury-location-group">
  <strong>Injury Location:</strong>
  <label><input type="checkbox" name="injuryloc-checkbox" value="leg" checked>Leg</label>
  <label><input type="checkbox" name="injuryloc-checkbox" value="arm" checked>Arm</label>
  <label><input type="checkbox" name="injuryloc-checkbox" value="torso" checked>Torso</label>
  <label><input type="checkbox" name="injuryloc-checkbox" value="other" checked>Other</label>
</div>

<!-- APPLY FILTERS BUTTON -->
<button id="apply-filters-btn">Apply Filters</button>
</div> <!-- end .window-body -->
</div> <!-- end #filter-window -->
<!-- resetting issue, commenting so that member can pull again -->

<!-- INCIDENT ANALYSIS WINDOW for deeper stats (body part distribution, etc.) -->
<div id="incident-analysis-window" class="floating-window hidden">
  <div id="incident-analysis-header" class="window-header">
    <span>Incident Analysis</span>
    <button id="analysis-close-btn" class="close-btn">X</button>
  </div>

  <div class="window-body">
    <h3>Injury Location Distribution</h3>
    <canvas id="injuryPieChart"></canvas>

    <h3>Fatality Trends by Month</h3>
    <canvas id="fatalityLineChart"></canvas>
  </div>
</div>

<!-- Toggle Button for Analysis Window (and Filter) -->
<div class="button-container">
  <button id="filter-toggle-button" class="filter-toggle-btn">Show Filters</button>
  <button id="analysis-toggle-button" class="filter-toggle-btn hidden">Show Analysis</button>
</div>

<!-- Overlay: Title + tooltip for the heatmap -->
<div class="map-overlay" id="features">
  <h2>Number of Incidents per State</h2>
  <div id="pd"><p>Hover over a state!</p></div>
</div>

<!-- Overlay: Legend showing color scale or intensity scale -->
<div id="legend"></div>

<!-- Bluetooth toggle replacing old button, for heatmap/dot view -->
<div id="toggle-view-overlay">
  <div class="switch-label">
    <span>Toggle view</span>
  </div>
  <div class="switch-toggle">
    <input type="checkbox" id="bluetooth">
    <label for="bluetooth"></label>
  </div>
</div>

<!-- Hover info panel for individual incident details -->
<div id="incident-info">
  <div><strong>Year:</strong> <span id="info-year"></span></div>
  <div><strong>Month:</strong> <span id="info-month"></span></div>
  <div><strong>State:</strong> <span id="info-state"></span></div>
  <div><strong>Shark Type:</strong> <span id="info-shark"></span></div>
  <div><strong>Injury Loc:</strong> <span id="info-injuryloc"></span></div>
  <div><strong>Fatal:</strong> <span id="info-fatal"></span></div>
</div>

<!-- CHARTS MODAL for per-state line/bar charts -->
<div id="plot-modal">
  <button id="close-modal">X</button>
  <h2>Incidents in <span id="modal-state-name"></span></h2>
  <canvas id="lineChart" width="550" height="300"></canvas>
  <canvas id="barChart" width="550" height="300" style="margin-top: 20px;"></canvas>
</div>

<!-- dash-app placeholders, needed if you integrate dash or jinja templating -->
<div id="dash-app">{%app_entry%}</div>
<footer>
  {%config%}
  {%scripts%}
  {%renderer%}
</footer>
<script>
  // 1) MAP & GLOBAL SETUP
  // Explanation: We declare the Mapbox token, a global dataset array,
  // layer IDs, and track whether we are in heatmap or dots mode.
  mapboxgl.accessToken = 'pk.eyJ1IjoiZGF2aWRpbGlzZWkiLCJhIjoiY200dm5keW96MDR0MDJtczg4cDR1MWpuaSJ9.ZiHUYV8L4-Hc_sIFiGFjGg';
  let globalData = [];
  const heatmapLayerId = 'australia-states-6j1kts';
  const dotsLayerId    = 'australian-shark-incident-dat-0xifxf';
  let showHeatmap = true;

  // Some key DOM references for toggling or showing/hiding elements
  const legendEl         = document.getElementById('legend');
  const featuresEl       = document.getElementById('features');
  const bluetoothCheckbox= document.getElementById('bluetooth');
  const toggleButton     = document.getElementById('filter-toggle-button');
  
  // 2) CHART.JS & HELPER FUNCTIONS
  // We maintain references to existing charts so we can destroy them before creating new ones.
  let lineChartInstance = null;
  let barChartInstance  = null;

  // createOrUpdateCharts: builds a line chart & bar chart for the clicked state
  function createOrUpdateCharts(stateName, yearlyData, sharkTypeData) {
    document.getElementById('modal-state-name').textContent = stateName;

    const years          = yearlyData.map(d => d.year);
    const countsOverTime = yearlyData.map(d => d.count);
    const sharkTypes     = sharkTypeData.map(s => s.shark);
    const sharkCounts    = sharkTypeData.map(s => s.count);

    // Destroy old charts if they exist
    if (lineChartInstance) lineChartInstance.destroy();
    if (barChartInstance)  barChartInstance.destroy();

    // Build line chart (Incidents Over Time)
    const lineCtx = document.getElementById('lineChart').getContext('2d');
    lineChartInstance = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: years,
        datasets: [{
          label: 'Incidents Over Time',
          data: countsOverTime,
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor:   'rgba(54, 162, 235, 1)',
          borderWidth: 2,
          fill: true
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } }
      }
    });

    // Build bar chart (Incidents by Shark Type)
    const barCtx = document.getElementById('barChart').getContext('2d');
    barChartInstance = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: sharkTypes,
        datasets: [{
          label: '# of Incidents by Shark Type',
          data: sharkCounts,
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          borderColor:   'rgba(255, 99, 132, 1)',
          borderWidth: 2
        }]
      },
      options: {
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // 3) INITIALIZE MAP & LEGEND
  // We set up the Mapbox map, adjust bounding, build the legend, etc.
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/davidilisei/cm4vkqj33001m01sf3zla3usi'
  });

  map.on('load', () => {
    map.getCanvas().style.cursor = 'default';
    map.fitBounds([[112.9, -43.7], [153.6, -10.0]]); // Zoom to Australia

    // Build the legend for the heatmap
    const layers = [
      '0-50','50-100','100-150','150-200',
      '200-250','250-300','300-400','400+'
    ];
    const colors = [
      '#FFEDA0','#FED976','#FEB24C','#FD8D3C',
      '#FC4E2A','#E31A1C','#BD0026','#800026'
    ];
    layers.forEach((layer, i) => {
      const color = colors[i];
      const item  = document.createElement('div');
      const key   = document.createElement('span');
      key.className = 'legend-key';
      key.style.backgroundColor = color;

      const value = document.createElement('span');
      value.innerHTML = layer;
      item.appendChild(key);
      item.appendChild(value);
      legendEl.appendChild(item);
    });

    // Show heatmap, hide dots initially
    map.setLayoutProperty(heatmapLayerId, 'visibility', 'visible');
    map.setLayoutProperty(dotsLayerId,    'visibility', 'none');

    // On mousemove, update "Hover" text for states in heatmap mode
    map.on('mousemove', (evt) => {
      if (showHeatmap) {
        const states = map.queryRenderedFeatures(evt.point, {
          layers: [heatmapLayerId]
        });
        document.getElementById('pd').innerHTML = states.length
          ? `<h3><span class="incidentsnmbr">${states[0].properties.incident_count}</span> || 
             <strong><em>${states[0].properties.State}</em></strong> shark incidents</h3>`
          : `<p>Hover over a state!</p>`;
      } else {
        document.getElementById('pd').innerHTML = '<p>Hover over a state!</p>';
      }
    });

    // Click on a state => gather real data from globalData => show charts
    map.on('click', heatmapLayerId, (evt) => {
      if (!showHeatmap) return;
      if (!evt.features.length) return;

      const feature      = evt.features[0];
      const clickedState = feature.properties.State || "Unknown";

      // 1) Filter globalData by that state
      const filtered = globalData.filter(incident => incident.State === clickedState);

      // 2) Aggregate by year
      const yearCounts = {};
      filtered.forEach(incident => {
        const y = parseInt(incident["Incident.year"]);
        if (!isNaN(y)) {
          if (!yearCounts[y]) yearCounts[y] = 0;
          yearCounts[y]++;
        }
      });
      const yearlyData = Object.entries(yearCounts)
        .map(([year, count]) => ({ year: +year, count }))
        .sort((a, b) => a.year - b.year);

      // 3) Aggregate by shark type
      const sharkCounts = {};
      filtered.forEach(incident => {
        const shark = incident["Shark.common.name"] || "Unknown";
        if (!sharkCounts[shark]) sharkCounts[shark] = 0;
        sharkCounts[shark]++;
      });
      const sharkData = Object.entries(sharkCounts)
        .map(([shark, count]) => ({ shark, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      // 4) Build charts in the modal
      createOrUpdateCharts(clickedState, yearlyData, sharkData);
      document.getElementById('plot-modal').style.display = 'block';
    });
  });

  // 4) DOT HOVER LOGIC: only applies if the dots layer is active
  let hoveredDotId = null;
  map.on('mousemove', dotsLayerId, (e) => {
    if (showHeatmap) return;
    if (!e.features.length) return;

    const f = e.features[0];
    const incYear  = f.properties["Incident.year"] || "";
    const incMonth = f.properties["Incident.month"] || "";
    const incState = f.properties["State"]         || "";
    const shark    = f.properties["Shark.common.name"] || "";
    const injury   = f.properties["Injury.location"]   || "";
    const isFatal  = (f.properties["Victim.injury"] === "fatal") ? "Yes" : "No";

    // Show small detail panel at #incident-info
    document.getElementById("info-year").textContent      = incYear;
    document.getElementById("info-month").textContent     = incMonth;
    document.getElementById("info-state").textContent     = incState;
    document.getElementById("info-shark").textContent     = shark;
    document.getElementById("info-injuryloc").textContent = injury;
    document.getElementById("info-fatal").textContent     = isFatal;

    document.getElementById("incident-info").style.display = "block";

    // Optionally highlight the hovered dot
    if (hoveredDotId !== null) {
      map.removeFeatureState({ source: dotsLayerId, id: hoveredDotId });
    }
    hoveredDotId = f.id;
    map.setFeatureState({ source: dotsLayerId, id: hoveredDotId }, { hover: true });
  });

  // Hide the detail panel when leaving dot layer
  map.on('mouseleave', dotsLayerId, () => {
    document.getElementById("incident-info").style.display = "none";
    if (hoveredDotId !== null) {
      map.setFeatureState({ source: dotsLayerId, id: hoveredDotId }, { hover: false });
    }
    hoveredDotId = null;
    map.getCanvas().style.cursor = '';
  });

  // 5) CHART MODAL CLOSE
  // If user clicks "X" on #plot-modal => hide that modal
  document.getElementById('close-modal').addEventListener('click', () => {
    document.getElementById('plot-modal').style.display = 'none';
  });

  // 6) APPLY FILTERS LOGIC: building a filter array for the dot layer
  document.getElementById('apply-filters-btn').addEventListener('click', () => {
    const [minYear, maxYear] = yearSliderDiv.noUiSlider.get().map(Number);
    const [minMonth, maxMonth] = monthSliderDiv.noUiSlider.get().map(Number);

    const stateCheckboxes = document.querySelectorAll('input[name="state-checkbox"]:checked');
    const selectedStates   = [...stateCheckboxes].map(cb => cb.value);

    const outcomeRadio = document.querySelector('input[name="injury-outcome"]:checked');
    const selectedOutcome = outcomeRadio ? outcomeRadio.value : 'all';

    const sharkCheckboxes = document.querySelectorAll('input[name="shark-checkbox"]:checked');
    const selectedSharks   = [...sharkCheckboxes].map(cb => cb.value);

    const injuryLocCheckboxes = document.querySelectorAll('input[name="injuryloc-checkbox"]:checked');
    const selectedInjuryLocs  = [...injuryLocCheckboxes].map(cb => cb.value);

    const filterArray = ["all"];

    // Year constraints
    filterArray.push([">=", ["to-number", ["get", "Incident.year"]], minYear]);
    filterArray.push(["<=", ["to-number", ["get", "Incident.year"]], maxYear]);

    // Month constraints
    filterArray.push([">=", ["to-number", ["get", "Incident.month"]], minMonth]);
    filterArray.push(["<=", ["to-number", ["get", "Incident.month"]], maxMonth]);

    // State check (only if not "select all")
    if (selectedStates.length > 0 && selectedStates.length < 8) {
      filterArray.push([
        "in",
        ["get", "State"],
        ["literal", selectedStates]
      ]);
    }
    // Outcome check
    if (selectedOutcome !== "all") {
      filterArray.push(["==", ["get", "Victim.injury"], selectedOutcome]);
    }
    // Shark check
    if (selectedSharks.length > 0 && selectedSharks.length < 21) {
      filterArray.push([
        "in",
        ["get", "Shark.common.name"],
        ["literal", selectedSharks]
      ]);
    } else if (selectedSharks.length === 0) {
      filterArray.push([
        "in",
        ["get", "Shark.common.name"],
        ["literal", []]
      ]);
    }
    // Injury location check
    if (selectedInjuryLocs.length > 0 && selectedInjuryLocs.length < 4) {
      filterArray.push([
        "in",
        ["get", "Injury.location"],
        ["literal", selectedInjuryLocs]
      ]);
    } else if (selectedInjuryLocs.length === 0) {
      filterArray.push([
        "in",
        ["get", "Injury.location"],
        ["literal", []]
      ]);
    }

    console.log("Applying filter:", JSON.stringify(filterArray, null, 2));
    map.setFilter(dotsLayerId, filterArray);
  });

  // 7) HEATMAP ↔ DOTS “BLUETOOTH” TOGGLE
  // Switch between the heatmap layer and the dot layer
  bluetoothCheckbox.addEventListener('change', (e) => {
    if (e.target.checked) {
      // Turn on Dot View
      map.setLayoutProperty(heatmapLayerId, 'visibility', 'none');
      map.setLayoutProperty(dotsLayerId, 'visibility', 'visible');
      legendEl.style.display = 'none';
      featuresEl.style.display = 'none';

      toggleButton.classList.remove('hidden');
      toggleButton.style.display = 'block';
      analysisToggleButton.classList.remove('hidden');
      analysisToggleButton.style.display = 'block';

      showHeatmap = false;
    } else {
      // Turn on Heatmap View
      map.setLayoutProperty(heatmapLayerId, 'visibility', 'visible');
      map.setLayoutProperty(dotsLayerId, 'visibility', 'none');
      legendEl.style.display = 'block';
      featuresEl.style.display = 'block';

      toggleButton.classList.add('hidden');
      toggleButton.style.display = 'none';
      analysisWindow.classList.add('hidden');
      analysisWindow.style.display = 'none';
      analysisToggleButton.classList.add('hidden');
      analysisToggleButton.style.display = 'none';

      showHeatmap = true;
    }
  });

  // Hide "Show Filters" button by default on page load
  window.addEventListener('DOMContentLoaded', () => {
    toggleButton.classList.add('hidden');
    toggleButton.style.display = 'none';
  });

  // Repeated event listener to ensure the same behavior
  window.addEventListener('DOMContentLoaded', () => {
    toggleButton.classList.add('hidden');
    toggleButton.style.display = 'none';
  });

  // 8) DUAL-RANGE SLIDER LOGIC (Year & Month)
  // (Implementation is likely below or in separate code, so no changes here)

  // 9) “SHOW FILTERS” BUTTON + FLOATING WINDOW DRAG
  // Logic to handle the filter window being shown/hidden and draggable
  const filterWindow    = document.getElementById('filter-window');
  const filterCloseBtn  = document.getElementById('filter-close-btn');
  const filterHeaderBar = document.getElementById('filter-window-header');

  toggleButton.addEventListener('click', () => {
    filterWindow.classList.toggle('hidden');
    toggleButton.textContent = filterWindow.classList.contains('hidden')
      ? 'Show Filters'
      : 'Hide Filters';
  });

  filterCloseBtn.addEventListener('click', () => {
    filterWindow.classList.add('hidden');
    toggleButton.textContent = 'Show Filters';
  });

  let isDragging   = false;
  let offsetX = 0, offsetY = 0;

  filterHeaderBar.addEventListener('mousedown', (e) => {
    isDragging = true;
    offsetX = e.clientX - filterWindow.offsetLeft;
    offsetY = e.clientY - filterWindow.offsetTop;
  });
  document.addEventListener('mousemove', (e) => {
        // If we aren't dragging the filter window, do nothing
        if (!isDragging) return;
        // Calculate new positions based on mouse
        const newLeft = e.clientX - offsetX;
        const newTop  = e.clientY - offsetY;
        // Move the filter window
        filterWindow.style.left = `${newLeft}px`;
        filterWindow.style.top  = `${newTop}px`;
      });
    
      document.addEventListener('mouseup', () => {
        // Stop dragging once mouse is released
        isDragging = false;
      });

////////////////////////////////////////
// 4a) Initialize the noUiSlider for "year"
////////////////////////////////////////
// Explanation: We create a dual-handle slider for selecting a year range
const yearSliderDiv = document.getElementById('year-slider');
noUiSlider.create(yearSliderDiv, {
  start: [1840, 1960], // default min & max
  connect: true,       // show a colored bar between knobs
  step: 1,
  range: {
    min: 1791,
    max: 2022
  }
});

// Whenever the slider changes, update the min/max year labels
yearSliderDiv.noUiSlider.on('update', (values, handle) => {
  const minYear = Math.floor(values[0]);
  const maxYear = Math.floor(values[1]);
  document.getElementById('year-min-value').textContent = minYear;
  document.getElementById('year-max-value').textContent = maxYear;
});

////////////////////////////////////////
// 4b) Initialize the noUiSlider for "month"
////////////////////////////////////////
// Another slider for month range (1-12)
const monthSliderDiv = document.getElementById('month-slider');
noUiSlider.create(monthSliderDiv, {
  start: [3, 9],   // default min & max
  connect: true,
  step: 1,
  range: {
    min: 1,
    max: 12
  }
});

// Show month range in #month-min-value and #month-max-value
monthSliderDiv.noUiSlider.on('update', (values, handle) => {
  const minMonth = Math.floor(values[0]);
  const maxMonth = Math.floor(values[1]);
  document.getElementById('month-min-value').textContent = minMonth;
  document.getElementById('month-max-value').textContent = maxMonth;
});

// (A) Toggle the block of state checkboxes
const toggleStatesBtn   = document.getElementById('toggle-states-btn');
const stateContainer    = document.getElementById('state-checkboxes-container');

toggleStatesBtn.addEventListener('click', () => {
  // Show/hide the container with the states
  stateContainer.classList.toggle('hidden');
  if (stateContainer.classList.contains('hidden')) {
    toggleStatesBtn.textContent = 'Show States';
  } else {
    toggleStatesBtn.textContent = 'Hide States';
  }
});

// (B) "Select All States" logic
const selectAllStates = document.getElementById('select-all-states');
selectAllStates.addEventListener('change', (e) => {
  const isChecked = e.target.checked;
  // Mark each individual state checkbox
  const allStateCheckboxes = document.querySelectorAll('input[name="state-checkbox"]');
  allStateCheckboxes.forEach(cb => {
    cb.checked = isChecked;
  });
});

// Toggle button for "Sharks"
const toggleSharksBtn = document.getElementById('toggle-sharks-btn');
const sharkCheckboxesContainer = document.getElementById('shark-checkboxes-container');

// "Select All Sharks" checkbox
const selectAllSharks = document.getElementById('select-all-sharks');

// Show/hide the shark checkboxes container when the "Show Sharks" button is clicked
toggleSharksBtn.addEventListener('click', () => {
  sharkCheckboxesContainer.classList.toggle('hidden');
  
  if (sharkCheckboxesContainer.classList.contains('hidden')) {
    toggleSharksBtn.textContent = 'Show Sharks';
  } else {
    toggleSharksBtn.textContent = 'Hide Sharks';
  }
});

// 2) "Select All" logic for sharks
selectAllSharks.addEventListener('change', (event) => {
  const isChecked = event.target.checked;
  // Toggle each shark checkbox based on the "Select All Sharks"
  const allSharkCheckboxes = document.querySelectorAll('input[name="shark-checkbox"]');
  allSharkCheckboxes.forEach(cb => {
    cb.checked = isChecked;
  });
});

// Elements controlling the analysis window (body part distribution, monthly trends)
const analysisWindow = document.getElementById('incident-analysis-window');
const analysisToggleButton = document.getElementById('analysis-toggle-button');
const analysisCloseButton = document.getElementById('analysis-close-btn');

// Show or hide the analysis window only in dots mode
analysisToggleButton.addEventListener('click', () => {
  if (!showHeatmap) {
    analysisWindow.classList.toggle('hidden');
    // If hidden, hide style, otherwise show
    analysisWindow.style.display = analysisWindow.classList.contains('hidden') ? 'none' : 'block';
    analysisToggleButton.textContent = analysisWindow.classList.contains('hidden') ? 'Show Analysis' : 'Hide Analysis';
  }
});

// Close the analysis window
analysisCloseButton.addEventListener('click', () => {
  analysisWindow.classList.add('hidden');
  analysisWindow.style.display = 'none';
  analysisToggleButton.textContent = 'Show Analysis';
});

// On DOM load, hide the analysis toggle button
window.addEventListener('DOMContentLoaded', () => {
  analysisToggleButton.classList.add('hidden');
  analysisToggleButton.style.display = 'none';
});

/*******************************************
 * CHART.JS REFERENCES
 *******************************************/
let bodyPartsBarChartInstance   = null; // histogram of injury location
let monthlyDensityChartInstance = null; // monthly distribution of fatal vs non-fatal

/*******************************************
 * FUNCTION: createIncidentCharts(data)
 * data: array of incident objects
 *******************************************/
function createIncidentCharts(data) {
  // Canvas references for bar chart (body part distribution) and line chart (monthly trends)
  const ctxBar  = document.getElementById('injuryPieChart').getContext('2d');
  const ctxLine = document.getElementById('fatalityLineChart').getContext('2d');

  const totalIncidents = data.length; // total filtered incidents

  const bodyPartCounts = {};
  const monthlyCounts      = new Array(12).fill(0);
  const monthlyFatalCounts = new Array(12).fill(0);

  // Count occurrences for each body part, also sum monthly totals
  data.forEach(incident => {
    const loc = incident["Injury.location"] || "Unknown";
    if (!bodyPartCounts[loc]) bodyPartCounts[loc] = 0;
    bodyPartCounts[loc]++;

    const m = parseInt(incident["Incident.month"]);
    if (!isNaN(m) && m >= 1 && m <= 12) {
      monthlyCounts[m - 1]++;
      if (incident["Victim.injury"] === "fatal") {
        monthlyFatalCounts[m - 1]++;
      }
    }
  });

  // Convert body part counts to percentages of total
  const bodyPartLabels = Object.keys(bodyPartCounts);
  const bodyPartPercs  = bodyPartLabels.map(loc => (bodyPartCounts[loc] / totalIncidents) * 100);

  const monthLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  // Destroy old charts before creating new ones
  if (bodyPartsBarChartInstance) bodyPartsBarChartInstance.destroy();
  if (monthlyDensityChartInstance) monthlyDensityChartInstance.destroy();

  // Bar chart for body part distribution
  bodyPartsBarChartInstance = new Chart(ctxBar, {
    type: 'bar',
    data: {
      labels: bodyPartLabels,
      datasets: [{
        label: '% of total incidents',
        data: bodyPartPercs,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor:     'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y', 
      scales: {
        x: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Percentage of All Incidents'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const val = context.parsed.x;
              return val.toFixed(1) + '%';
            }
          }
        }
      }
    }
  });

  // Line chart for monthly distribution
  monthlyDensityChartInstance = new Chart(ctxLine, {
    type: 'line',
    data: {
      labels: monthLabels,
      datasets: [
        {
          label: 'All Attacks',
          data: monthlyCounts,
          borderColor:   'rgba(75, 192, 192, 1)',
          backgroundColor:'rgba(75, 192, 192, 0.2)',
          tension: 0.2,
          fill: true
        },
        {
          label: 'Fatal Attacks',
          data: monthlyFatalCounts,
          borderColor:   'rgba(255, 99, 132, 1)',
          backgroundColor:'rgba(255, 99, 132, 0.2)',
          tension: 0.2,
          fill: true
        }
      ]
    },
    options: {
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

// Finally, we load our real JSON data and store it in globalData for other logic
fetch('sharkdataset.json')
  .then(response => response.json())
  .then(realData => {
    globalData = realData;
    createIncidentCharts(globalData); // optional initial analysis
  })
  .catch(err => console.error("Failed to load data:", err));
    </script>
  </body>
</html>
